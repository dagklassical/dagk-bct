---
// src/pages/musica/colecciones/[id].astro
import Layout from '../../../layouts/Layout.astro';
import releases from '../../../data/releases.json';

// 1. Define las rutas estáticas basadas en releases.json
export async function getStaticPaths() {
  // Asegúrate de que 'releases' no esté vacío
  if (!releases || !Array.isArray(releases)) {
    throw new Error("El archivo releases.json no contiene un array válido.");
  }

  // Genera una ruta para cada release en el JSON
  return releases.map(release => ({
    params: { id: release.id }, // El 'id' aquí debe coincidir con [id].astro
    props: { release }, // Pasa el objeto 'release' como prop
  }));
}

// 2. Recibe el 'id' de la URL y el 'release' ya filtrado de getStaticPaths
const { id } = Astro.params;
// En build time, Astro ya pasó el 'release' correcto vía props
const release = Astro.props.release;

// Validación: Si no se encontró el release (aunque getStaticPaths debería garantizarlo), redirige
if (!release) {
  // Esto no debería pasar si getStaticPaths es correcto, pero es buena práctica
  return Astro.redirect('/musica/discografia');
}

const pageTitle = `${release.title} - Discografía`;
const pageDescription = `Detalles de la colección "${release.title}" por ${release.artistId}.`;
---

<Layout title={pageTitle} description={pageDescription}>
  <article class="max-w-4xl mx-auto p-4">
    <div class="flex flex-col md:flex-row gap-6">
      <div class="md:w-1/3">
        <img
          src={release.coverImage}
          alt={release.title}
          class="w-full rounded-lg shadow-md"
          // Opcional: placeholder
          // src="https://placehold.co/300/cccccc/999999?text=Cover"
        />
      </div>
      <div class="md:w-2/3">
        <h1 class="text-3xl font-bold mb-2">{release.title}</h1>
        <p class="text-xl text-slate-600 mb-2">por {release.artistId}</p>
        <p class="text-slate-500 mb-4">{release.genre} • {new Date(release.releaseDate).toLocaleDateString('es-VE')} • {release.type}</p>

        <section class="mb-6">
          <h2 class="text-xl font-semibold mb-3">Tracklist</h2>
          <ul class="list-disc pl-5 space-y-1">
            {release.tracks.map(track => (
              <li key={track.title}>{track.title} <span class="text-slate-500">({track.duration})</span></li>
            ))}
          </ul>
        </section>

        <section>
          <h2 class="text-xl font-semibold mb-3">Music Cards Disponibles</h2>
          {release.musicCards.length > 0 ? (
            release.musicCards.map(card => (
              <div key={card.cardId} class="border border-platinum p-4 rounded-lg bg-white shadow-sm mb-3">
                <p><strong>ID:</strong> {card.cardId}</p>
                <p><strong>Edición:</strong> {card.edition} ({card.available}/{card.totalSupply} disponibles)</p>
                <p><strong>Blockchain:</strong> {card.blockchain}</p>
                <p><strong>Token ID:</strong> {card.tokenId}</p>
                <button class="mt-2 bg-platinum text-white px-4 py-2 rounded hover:bg-opacity-80">
                  Adquirir (Próximamente)
                </button>
              </div>
            ))
          ) : (
            <p>No hay Music Cards disponibles para esta colección aún.</p>
          )}
        </section>
      </div>
    </div>

    <!-- Metadatos inmutables -->
    <div class="mt-8 p-4 border-t border-platinum text-sm text-slate-600">
      <h3 class="font-semibold mb-2">Metadatos Inmutables</h3>
      <p><strong>UUID:</strong> {release.metadata.uuid}</p>
      <p><strong>Timestamp:</strong> {release.metadata.timestamp}</p>
      <p><strong>Operador:</strong> {release.metadata.operator}</p>
      <p><strong>SHA256 (Placeholder):</strong> {release.metadata.sha256}</p>
    </div>
  </article>
</Layout>