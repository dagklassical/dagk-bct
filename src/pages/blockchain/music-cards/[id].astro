---
// src/pages/blockchain/music-cards/[id].astro
import Layout from '../../../layouts/Layout.astro';
import ImmutableStamp from '../../../components/ImmutableStamp.astro';
import musicCards from '../../../data/music-cards.json';
import releases from '../../../data/releases.json';
import artists from '../../../data/artists.json';

// Genera una página estática para cada Music Card
export async function getStaticPaths() {
  return musicCards
    .filter(card => card.status === 'available') // solo públicas
    .map(card => ({
      params: { id: card.id },
      props: { card }
    }));
}

const { id } = Astro.params;
const card = Astro.props.card;

if (!card) {
  return Astro.redirect('/blockchain/music-cards');
}

// Obtiene la obra asociada
const release = releases.find(r => r.id === card.associatedRelease);
const artist = artists.find(a => a.id === release?.artistIds?.[0]);

// Migas de pan
const breadcrumbs = [
  { label: 'Inicio', href: '/' },
  { label: 'Blockchain', href: '/blockchain/' },
  { label: 'Music Cards', href: '/blockchain/music-cards/' },
  { label: card.title, href: `/blockchain/music-cards/${id}` },
];
---

<Layout title={card.title} description={release?.description || 'Music Card verificable en blockchain'} breadcrumbs={breadcrumbs}>

  <!-- Hero con imagen de la Music Card -->
  <section 
    class="relative h-96 md:h-[500px] w-full"
    style={`background-image: url('${card.cardImage}'); background-position: center; background-size: cover;`}
  >
    <div class="absolute inset-0 bg-black/50 flex items-center justify-center">
      <div class="text-center text-white max-w-4xl px-4">
        <h1 class="text-3xl md:text-5xl font-advent font-bold mb-2">{card.title}</h1>
        {artist?.name && <p class="text-lg md:text-xl">{artist.name}</p>}
      </div>
    </div>
  </section>

  <!-- Reproductor interactivo -->
  <div class="max-w-3xl mx-auto px-4 -mt-6 mb-8">
    <div class="bg-white border border-platinum rounded-xl overflow-hidden shadow-sm">
      <audio id="music-player" controls class="w-full h-16"></audio>
    </div>
  </div>

  <article class="max-w-4xl mx-auto px-4 pb-12">

    <!-- Valor y disponibilidad -->
    <section class="bg-dag-burgundy/10 border border-dag-burgundy/30 rounded-lg p-6 mb-8">
      <div class="flex flex-wrap justify-between items-center">
        <div>
          <span class="inline-block px-3 py-1 bg-dag-burgundy text-white text-sm rounded mr-2">{card.edition}</span>
          <span class="text-slate-600 text-sm">{card.available} de {card.totalSupply} disponibles</span>
        </div>
        <div class="text-right">
          <p class="text-lg font-bold">{card.price}</p>
          <p class="text-xs text-slate-600">en {card.blockchain}</p>
        </div>
      </div>
    </section>

    <!-- Tracklist interactivo -->
    {release?.tracks && (
      <section class="mb-8">
        <h2 class="text-2xl font-advent font-semibold mb-4 text-center">Tracklist</h2>
        <div class="bg-white p-5 rounded-lg border border-platinum">
          <ol class="space-y-2">
            {release.tracks.map((track, i) => (
              <li 
                key={i}
                data-demo={track.demo || '/protected/demo/corre-caballito-demo.mp3'}
                class="flex justify-between items-center py-2 border-b border-slate-100 last:border-0 cursor-pointer hover:bg-slate-50"
              >
                <span class="font-medium">{i + 1}. {track.title}</span>
                <span class="text-slate-500 text-sm">{track.duration}</span>
              </li>
            ))}
          </ol>
        </div>
      </section>
    )}

    <!-- Beneficios (solo anuncio) -->
    <section class="grid md:grid-cols-2 gap-6 mb-8">
      <div class="bg-white p-5 rounded-lg border border-platinum text-center">
        <h3 class="font-semibold mb-2">Audio de Colección</h3>
        <p class="text-sm text-slate-600 mb-3">FLAC 24-bit/192kHz</p>
        <p class="text-xs text-slate-500">Acceso exclusivo tras adquisición</p>
      </div>
      <div class="bg-white p-5 rounded-lg border border-platinum text-center">
        <h3 class="font-semibold mb-2">Partitura Digital</h3>
        <p class="text-sm text-slate-600 mb-3">Firmada por {artist?.name}</p>
        <p class="text-xs text-slate-500">Incluida en esta edición</p>
      </div>
    </section>

    <!-- Biografía del artista -->
    {artist && (
      <section class="mb-8 bg-gray95 p-5 rounded-lg">
        <h3 class="text-xl font-semibold mb-2">Sobre {artist.name}</h3>
        <p class="mb-3">{artist.bio}</p>
        <a href={`/musica/artistas/${artist.id}`} class="text-dag-burgundy hover:underline text-sm">
          Explorar su trayectoria →
        </a>
      </section>
    )}

    <!-- Comentario de la obra -->
    {release?.commentary && (
      <section class="mb-8 italic border-l-4 border-dag-burgundy pl-4 py-2">
        “{release.commentary}”
        <footer class="mt-2 text-slate-600 text-sm">— {release.commentaryAuthor}</footer>
      </section>
    )}

    <!-- Call to action: Comprar -->
    <section class="text-center mb-8">
      <a href="#" class="inline-block bg-dag-burgundy text-white px-8 py-4 rounded-lg hover:bg-opacity-90 transition-colors font-medium text-lg">
        Adquirir esta Music Card
      </a>
      <p class="text-xs text-slate-500 mt-2">Certificada en {card.blockchain}. Incluye todos los beneficios exclusivos.</p>
    </section>

    <!-- Información técnica -->
    <section class="p-4 border-t border-platinum text-sm text-slate-600">
      <p><strong>Token ID:</strong> {card.tokenId}</p>
      <p><strong>Contrato:</strong> <code class="text-xs bg-slate-100 p-1 rounded">{card.contractAddress}</code></p>
      <a href={`https://polygonscan.com/token/${card.contractAddress}?a=${card.tokenId}`} target="_blank" class="text-sm text-dag-burgundy hover:underline">
        Ver en Polygonscan →
      </a>
    </section>

    <!-- Sello inmutable -->
    <ImmutableStamp 
      uuid={card.metadata.uuid}
      timestamp={card.metadata.timestamp}
      operator={card.metadata.operator}
    />
  </article>

  <!-- Script de interactividad -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const player = document.getElementById('music-player');
      document.querySelectorAll('[data-demo]').forEach(item => {
        item.addEventListener('click', () => {
          player.src = item.getAttribute('data-demo');
          player.load();
          player.play().catch(e => console.warn("Reproducción fallida:", e));
        });
      });
    });
  </script>
</Layout>